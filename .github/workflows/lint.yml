name: Comprehensive Python CI/CD

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, feature/* ]

jobs:
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi
          # Install linting tools
          pip install black isort flake8 mypy

      - name: Run Black formatter
        run: |
          echo "ğŸ¨ Running Black formatter..."
          black --check --diff . || (black . && echo "âœ… Code formatted with Black")

      - name: Run isort import sorter
        run: |
          echo "ğŸ“š Running isort..."
          isort --check --diff . || (isort . && echo "âœ… Imports sorted with isort")

      - name: Run Flake8 linter
        run: |
          echo "ğŸ” Running Flake8..."
          flake8 . --max-line-length=88 --extend-ignore=E203,W503

      - name: Run MyPy type checking
        run: |
          echo "ğŸ” Running MyPy type checking..."
          mypy . --ignore-missing-imports || echo "âš ï¸ MyPy found type issues"

      - name: Commit and push formatting fixes
        if: github.event_name == 'pull_request'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if ! git diff --quiet; then
            echo "ğŸ“ Auto-fixing formatting issues and committing changes"
            git add .
            git commit -m "Auto-fix Python formatting

            Automatically applied Black and isort fixes during PR workflow.

            - Fixed code formatting with Black
            - Sorted imports with isort
            - No manual intervention required"

            git push origin HEAD:${{ github.head_ref }}
            echo "âœ… Formatting fixes committed and pushed"
          else
            echo "âœ… No formatting fixes needed"
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi
          pip install pytest pytest-cov

      - name: Install package in development mode
        run: |
          echo "ğŸ“¦ Installing package in development mode..."
          pip install -e .

      - name: Run core unit tests
        run: |
          echo "ğŸ§ª Running core unit tests..."
          pytest tests/ -v --cov=src/music_theory_analysis --cov-report=term-missing --cov-report=xml

      - name: Generate comprehensive test data
        run: |
          echo "ğŸ¯ Generating comprehensive test data..."
          python scripts/generate_test_data.py
          echo "âœ… Generated test data files:"
          ls -la tests/generated/

      - name: Validate behavioral parity
        run: |
          echo "ğŸ¼ Validating behavioral parity with comprehensive test suite..."
          python scripts/validate_with_generated_data.py

      - name: Upload coverage reports
        if: github.event_name == 'pull_request'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
