# Testing Framework Guide

## Testing Philosophy and Framework

### Comprehensive Multi-Layer Testing
The test suite validates **multiple analytical perspectives simultaneously**:

### Edge Case Behavioral Testing Framework
**New Addition (August 2025)**: Comprehensive behavioral testing for edge cases that validates appropriate graceful degradation rather than expecting normal performance.

**Key Components:**
- **EdgeCaseType Enum**: Categorizes different types of edge cases (INSUFFICIENT_DATA, STATIC_HARMONY, PATHOLOGICAL_INPUT, CONTEXTUAL_DEPENDENCY)
- **EdgeCaseBehaviorExpectation**: Defines expected behavior patterns for each edge case type
- **Behavioral Validation**: Tests that edge cases behave appropriately as edge cases

**Test File**: `tests/test_edge_case_behavior.py`

**Edge Case Categories:**
```python
class EdgeCaseType(Enum):
    INSUFFICIENT_DATA = "insufficient_data"      # Single chord, empty
    AMBIGUOUS_HARMONY = "ambiguous_harmony"      # Multiple valid interpretations
    PATHOLOGICAL_INPUT = "pathological_input"    # Invalid or nonsensical
    CONTEXTUAL_DEPENDENCY = "contextual_dependency"  # Needs more context
    STATIC_HARMONY = "static_harmony"            # No harmonic motion
```

**Behavioral Expectations:**
- **Single Chords**: ≤0.4 confidence, acknowledge limitations in reasoning
- **Static Harmony**: ≤0.3 confidence, mention repetition/static nature
- **Pathological Input**: ≤0.5 confidence, acknowledge unusual nature
- **Contextual Dependency**: ≤0.6 confidence, acknowledge ambiguity

**Testing Philosophy**: Edge cases should demonstrate appropriate uncertainty and provide educational explanations rather than failing entirely.

```python
@dataclass
class MultiLayerTestCase:
    chords: List[str]                          # Input progression
    expected_functional: FunctionalExpectation # Roman numerals, key, confidence
    expected_modal: ModalExpectation           # Mode, parent key, local tonic
    expected_chromatic: ChromaticExpectation   # Secondary dominants, borrowed chords
    expected_display: DisplayExpectation       # Confidence thresholds, output expectations
    validation_criteria: ValidationCriteria    # Success/failure criteria
```

## Test Suite Architecture

### Comprehensive Multi-Layer Tests (427 cases)
Generated by `scripts/generate_comprehensive_multi_layer_tests.py`:

**Test Categories:**
- `modal_characteristic`: 168 tests - Modal progressions with clear characteristics
- `modal_contextless`: 168 tests - Modal progressions without parent key context
- `functional_clear`: 60 tests - Clear functional harmony progressions
- `chromatic_secondary`: 4 tests - Secondary dominant progressions
- `chromatic_borrowed`: 3 tests - Borrowed chord progressions
- `ambiguous`: 9 tests - Theoretically ambiguous progressions
- `edge_*`: 10 tests - Edge cases and special situations
- `jazz_complex`: 3 tests - Complex jazz harmony
- `extended_harmony`: 2 tests - Extended chord progressions

### Test Validation Approach
Each test case includes multi-layer expectations:
- **Functional**: Expected Roman numerals, key center, confidence
- **Modal**: Expected mode, parent key, local tonic, confidence
- **Chromatic**: Expected secondary dominants, borrowed chords
- **Display**: Confidence thresholds and output format expectations

### Edge Case Behavioral Validation (New)
**File**: `tests/test_edge_case_behavior.py` - 311 lines of comprehensive behavioral testing

**Key Test Methods:**
- `test_single_chord_graceful_degradation()`: Validates single chord analysis with appropriate limitations
- `test_static_harmony_behavior()`: Tests repeated chord sequences (C-C-C) with low confidence
- `test_pathological_input_handling()`: Handles unusual sequences (chromatic, augmented, enharmonic)
- `test_contextual_dependency_cases()`: Tests ambiguous progressions (C-G could be I-V or V-I)
- `test_edge_case_consistency()`: Ensures consistent behavior across similar edge cases

**Behavioral Expectations Framework:**
```python
@dataclass
class EdgeCaseBehaviorExpectation:
    case_type: EdgeCaseType
    max_confidence: float                    # Confidence ceiling for edge cases
    max_alternatives: int                    # Expected number of alternatives
    required_reasoning_keywords: List[str]   # Must appear in reasoning
    analysis_should_contain: List[str]       # Expected content in analysis
    should_not_contain: List[str]           # Inappropriate confident language
```

**Success Criteria**: 80%+ behavioral validation (testing that edge cases behave appropriately, not that they perform normally)

### Test Categories and Coverage
- **modal_characteristic (168 tests)**: Progressions with clear modal features
- **modal_contextless (168 tests)**: Modal progressions without key context
- **functional_clear (60 tests)**: Unambiguous functional harmony
- **chromatic_* (7 tests)**: Secondary dominants and borrowed chords
- **ambiguous (9 tests)**: Theoretically unclear progressions
- **edge_* (10 tests)**: Single chords, repetition, enharmonic equivalents
- **jazz_complex (5 tests)**: Extended harmony and complex progressions

### Success Criteria Philosophy
Tests validate **theoretical accuracy** rather than user preference:
- Modal tests require specific mode identification and parent key
- Functional tests require accurate Roman numeral analysis
- Confidence tests ensure analytical certainty matches evidence strength
- Display tests verify appropriate confidence thresholds for output formatting

## Development Commands

### Testing
```bash
# Full comprehensive test suite
python -m pytest tests/test_comprehensive_multi_layer_validation.py -v

# Edge case behavioral testing
python -m pytest tests/test_edge_case_behavior.py -v

# Specific category testing
python -m pytest tests/test_comprehensive_multi_layer_validation.py::TestComprehensiveMultiLayerValidation::test_modal_characteristic_cases -v

# Generate fresh test data
python scripts/generate_comprehensive_multi_layer_tests.py

# Core functionality tests
python -m pytest tests/test_enhanced_modal_analyzer.py -v
python -m pytest tests/test_functional_harmony.py -v

# Run all tests including edge case validation
python -m pytest tests/ -v --tb=short
```

### Testing Infrastructure
- `tests/test_comprehensive_multi_layer_validation.py` - Main validation suite
- `scripts/generate_comprehensive_multi_layer_tests.py` - Test data generator
- `tests/generated/comprehensive-multi-layer-tests.json` - Generated test cases

## Testing Requirements
- Always run comprehensive tests before commits
- Modal characteristic tests must maintain 60%+ success rate
- New features require corresponding test cases
